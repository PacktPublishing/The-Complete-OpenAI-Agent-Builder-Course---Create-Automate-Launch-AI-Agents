import { webSearchTool, RunContext, Agent, AgentInputItem, Runner } from "@openai/agents";
import { z } from "zod";


// Tool definitions
const webSearchPreview = webSearchTool({
  searchContextSize: "medium",
  userLocation: {
    type: "approximate"
  }
})
const KeywordResearcherSchema = z.object({ keywords: z.array(z.string()) });
interface KeywordResearcherContext {
  stateNumKeywords: string;
  stateTopic: string;
}
const keywordResearcherInstructions = (runContext: RunContext<KeywordResearcherContext>, _agent: Agent<KeywordResearcherContext>) => {
  const { stateNumKeywords, stateTopic } = runContext.context;
  return `You are an agent that generates ${stateNumKeywords}  keyword phrases based on the provided topic from the previous output.
Use these keywords to further research into the topic.

NOTE:
Only return the list of keywords.

Topic:
 ${stateTopic} `
}
const keywordResearcher = new Agent({
  name: "Keyword Researcher",
  instructions: keywordResearcherInstructions,
  model: "gpt-5",
  outputType: KeywordResearcherSchema,
  modelSettings: {
    reasoning: {
      effort: "low",
      summary: "auto"
    },
    store: true
  }
});

interface ResearchAgentContext {
  stateTopic: string;
  stateCurrKeyword: string;
}
const researchAgentInstructions = (runContext: RunContext<ResearchAgentContext>, _agent: Agent<ResearchAgentContext>) => {
  const { stateTopic, stateCurrKeyword } = runContext.context;
  return `Your roles is to do deep research into a topic using a specific keyword.  Make sure to use the web search tool to retrieve the 3 most relevant articles related to the keywords provided.

Return a detailed research report in markdown format.

Topic:
 ${stateTopic}

Keyword:
 ${stateCurrKeyword}`
}
const researchAgent = new Agent({
  name: "Research Agent",
  instructions: researchAgentInstructions,
  model: "gpt-5",
  tools: [
    webSearchPreview
  ],
  modelSettings: {
    reasoning: {
      effort: "low",
      summary: "auto"
    },
    store: true
  }
});

interface SummaryAgentContext {
  stateTopic: string;
}
const summaryAgentInstructions = (runContext: RunContext<SummaryAgentContext>, _agent: Agent<SummaryAgentContext>) => {
  const { stateTopic } = runContext.context;
  return `You are tasked with consolidating all information researched and generated by previous agents, then producing an easy-to-read summary of their findings.

Use the topic:
${stateTopic}

- Carefully review all content created or gathered by previous agents.
- Identify key points, central findings, supporting details, and any relevant context.
- Organize information logically and concisely, grouping similar ideas together.
- Rewrite the material into a clear and accessible summary that is easily understood by someone unfamiliar with the details.
- Do not omit critical information, but prioritize clarity and brevity.
- Before delivering the final summary, reflect to ensure that all main points from previous agents are included and the summary accurately represents their collective research.

**Output Format:**  
- Provide a single, well-structured paragraph (or 2-3 short paragraphs if needed for clarity), written in plain English.
- Ensure the summary is logically organized, concise, and free from technical jargon.
- Do not include introductory or concluding statements beyond the summary itself.

**Example Input (previous agents' findings):**  
Agent 1: \"The new policy was implemented in March 2022 and aimed to reduce carbon emissions.\"  
Agent 2: \"Within six months, emission levels dropped by 10%. Stakeholders reported high satisfaction with the changes.\"  

**Example Output (summary):**  
The new policy, implemented in March 2022, aimed to reduce carbon emissions and led to a 10% decrease within six months. Stakeholders expressed high satisfaction with these changes.

_Reminder: Your objective is to comprehensively, clearly, and concisely summarize the findings of previous agents in an easy-to-read paragraph(s), ensuring all main points are included._ `
}
const summaryAgent = new Agent({
  name: "Summary Agent",
  instructions: summaryAgentInstructions,
  model: "gpt-5",
  modelSettings: {
    reasoning: {
      effort: "low",
      summary: "auto"
    },
    store: true
  }
});

const approvalRequest = (message: string) => {

  // TODO: Implement
  return true;
}

type WorkflowInput = { input_as_text: string };


// Main code entrypoint
export const runWorkflow = async (workflow: WorkflowInput) => {
  const state = {
    topic: null,
    num_keywords: 3,
    keywords: {
      keywords: []
    },
    num_iterations: 0,
    curr_keyword: null
  };
  const conversationHistory: AgentInputItem[] = [
    {
      role: "user",
      content: [
        {
          type: "input_text",
          text: workflow.input_as_text
        }
      ]
    }
  ];
  const runner = new Runner({
    traceMetadata: {
      __trace_source__: "agent-builder",
      workflow_id: "wf_68efe292ee6c8190a1c9b585a09b3f900b5bca9627247b14"
    }
  });
  state.topic = workflow.input_as_text;
  const keywordResearcherResultTemp = await runner.run(
    keywordResearcher,
    [
      ...conversationHistory
    ],
    {
      context: {
        stateNumKeywords: state.num_keywords,
        stateTopic: state.topic
      }
    }
  );
  conversationHistory.push(...keywordResearcherResultTemp.newItems.map((item) => item.rawItem));

  if (!keywordResearcherResultTemp.finalOutput) {
      throw new Error("Agent result is undefined");
  }

  const keywordResearcherResult = {
    output_text: JSON.stringify(keywordResearcherResultTemp.finalOutput),
    output_parsed: keywordResearcherResultTemp.finalOutput
  };
  state.keywords = keywordResearcherResult.output_parsed.keywords;
  const approvalMessage = `Are you sure you want to proceed with these keywords:
${state.keywords}`;

  if (approvalRequest(approvalMessage)) {
      while (state.num_iterations < state.num_keywords) {
        state.curr_keyword = state.keywords[state.num_iterations];
        const researchAgentResultTemp = await runner.run(
          researchAgent,
          [
            ...conversationHistory
          ],
          {
            context: {
              stateTopic: state.topic,
              stateCurrKeyword: state.curr_keyword
            }
          }
        );
        conversationHistory.push(...researchAgentResultTemp.newItems.map((item) => item.rawItem));

        if (!researchAgentResultTemp.finalOutput) {
            throw new Error("Agent result is undefined");
        }

        const researchAgentResult = {
          output_text: researchAgentResultTemp.finalOutput ?? ""
        };
        state.num_iterations = state.num_iterations + 1;
      }
      const summaryAgentResultTemp = await runner.run(
        summaryAgent,
        [
          ...conversationHistory
        ],
        {
          context: {
            stateTopic: state.topic
          }
        }
      );
      conversationHistory.push(...summaryAgentResultTemp.newItems.map((item) => item.rawItem));

      if (!summaryAgentResultTemp.finalOutput) {
          throw new Error("Agent result is undefined");
      }

      const summaryAgentResult = {
        output_text: summaryAgentResultTemp.finalOutput ?? ""
      };
  } else {
      return keywordResearcherResult;
  }
}
